# Banana Slides 便携版打包说明

## 概述

本文档说明如何创建 Banana Slides 的便携版发布包。

---

## 打包工具

**脚本位置**: `portable/build-release.ps1`

**功能**:
- 导出 origin/main 分支的干净代码
- 添加 portable 目录(包含启动脚本和配置)
- 自动清理开发文件(.venv、node_modules、.git 等)
- 创建 ZIP 压缩包

---

## 使用方法

### 方法 1: 使用默认版本号

```powershell
cd portable
.\build-release.ps1
```

这将使用 `frontend/package.json` 中的版本号(当前: 0.3.0)

### 方法 2: 指定版本号

```powershell
cd portable
.\build-release.ps1 -Version "1.0.0"
```

### 方法 3: 跳过工作区检查

如果有未提交的更改但仍想打包:

```powershell
cd portable
.\build-release.ps1 -SkipCleanCheck
```

---

## 打包流程

脚本执行以下步骤:

### 1. 检查 Git 工作区状态
- 检查是否有未提交的更改
- 如有更改,提示用户确认是否继续

### 2. 获取版本信息
- 从 `frontend/package.json` 读取默认版本号
- 获取 Git 分支和提交信息
- 显示版本详情

### 3. 准备临时目录
- 创建带时间戳的临时目录: `temp_release_YYYYMMDD_HHMMSS`
- 确保 `releases/` 输出目录存在

### 4. 导出项目文件
- 使用 `git archive` 从 **origin/main** 分支导出代码
- 如果 origin/main 不存在,使用当前 HEAD
- 确保导出的是干净的、已提交的代码

### 5. 添加 portable 目录
- 复制 `portable/` 目录到打包目录
- 排除打包脚本本身和旧的 ZIP 包
- 保留启动脚本和配置文件

### 6. 清理不需要的文件
自动清理以下内容:
- 虚拟环境: `.venv`
- Git 相关: `.git`, `.github`, `.githooks`
- 依赖目录: `node_modules`
- 构建产物: `dist`, `build`
- Python 缓存: `__pycache__`, `*.pyc`
- 测试文件: `.pytest_cache`, `.coverage`, `htmlcov`
- 数据目录: `instance`, `uploads`
- 配置文件: `.env`
- 临时文件: `temp_*`, `*.log`
- 开发工具: `.spec-workflow`

### 7. 创建 ZIP 包
- 文件名格式: `banana-slides-portable-v{版本号}.zip`
- 保存到 `releases/` 目录
- 使用最优压缩级别
- 显示文件大小和详细信息

---

## 输出结果

打包完成后,会生成:

**文件位置**: `releases/banana-slides-portable-v{版本号}.zip`

**包含内容**:
```
banana-slides-portable-v0.3.0.zip
├── backend/             # 后端源代码
├── frontend/            # 前端源代码
├── portable/            # 便携版启动脚本
│   ├── 一键启动.bat    # Windows 启动脚本
│   ├── menu.ps1         # PowerShell 管理菜单
│   ├── .env.default     # 默认配置模板
│   └── .proxy.default   # 代理配置模板
├── pyproject.toml       # Python 项目配置
├── package.json         # Node.js 项目配置
├── LICENSE              # 许可证
└── README.md            # 项目说明
```

**不包含**:
- ❌ .venv (虚拟环境)
- ❌ node_modules (前端依赖)
- ❌ .git (Git 仓库)
- ❌ instance (数据库文件)
- ❌ uploads (用户上传)
- ❌ .env (敏感配置)

---

## 用户使用流程

### 1. 解压 ZIP 包

用户将 ZIP 包解压到任意目录,例如:
```
C:\Users\用户名\banana-slides\
```

### 2. 运行启动脚本

双击 `portable\一键启动.bat`

### 3. 首次启动流程

#### 环境检查
脚本会自动检查:
- ✅ uv 或 Python (优先使用 uv)
- ✅ Node.js

如果缺少,会显示安装指引:

**安装 uv (推荐)**:
```powershell
powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"
```

**安装 Node.js**:
下载地址: https://nodejs.org/

#### 配置文件
- 自动从 `portable/.env.default` 复制默认配置
- 询问是否编辑配置文件
- 默认配置即可直接使用(使用免费代理服务)

#### 依赖安装
- **后端**: `uv sync --python 3.12` (自动下载 Python 3.12 并安装依赖)
- **前端**: `npm install`

#### 服务启动
- 后端: http://localhost:5000
- 前端: http://localhost:3000
- 自动打开浏览器

---

## 技术细节

### Python 版本管理

**pyproject.toml 配置**:
```toml
requires-python = ">=3.10,<3.13"
```

**启动脚本指定**:
```batch
uv sync --python 3.12
```

- uv 会自动下载 Python 3.12.x 最新版本
- 无需用户手动安装 Python
- 虚拟环境创建在项目根目录 `.venv`

### Git Archive 原理

```powershell
git archive --format=zip --output="archive.zip" origin/main
```

- 只导出已提交的文件
- 不包含 .git 目录
- 不包含 .gitignore 的文件
- 确保代码干净、可复现

### 清理策略

使用 PowerShell 递归删除:
```powershell
Get-ChildItem -Path $tempDir -Filter "node_modules" -Recurse -Force | Remove-Item -Recurse -Force
```

确保打包后的 ZIP 体积小、内容纯净。

---

## 常见问题

### Q: 如何更新版本号?

**A**: 有两种方式:

1. 修改 `frontend/package.json` 中的 `version` 字段,然后运行脚本
2. 运行脚本时指定: `.\build-release.ps1 -Version "1.0.0"`

### Q: 打包时提示有未提交的更改?

**A**: 两种选择:

1. 提交更改后再打包(推荐)
2. 使用 `-SkipCleanCheck` 跳过检查

### Q: 如何验证打包是否正确?

**A**: 建议测试流程:

1. 解压 ZIP 到全新目录
2. 在干净的虚拟机或沙箱环境测试
3. 确认首次启动流程完整可用
4. 测试所有核心功能

### Q: ZIP 包太大怎么办?

**A**: 脚本已自动清理所有开发文件,正常大小应在 5-10 MB。如果过大,检查:

1. 是否有大文件误提交到 Git
2. `portable/` 目录是否包含不必要的文件
3. 检查 `.gitignore` 配置

---

## 发布检查清单

打包前请确认:

- [ ] 所有代码已提交到 Git
- [ ] 已合并到 origin/main 分支
- [ ] 版本号已更新
- [ ] CHANGELOG 已更新
- [ ] README 已更新
- [ ] 所有测试通过
- [ ] 在干净环境测试过便携版

打包后请确认:

- [ ] ZIP 包可正常解压
- [ ] 文件结构正确
- [ ] 启动脚本可执行
- [ ] 首次启动流程完整
- [ ] 所有功能正常工作

---

## 相关文件

| 文件 | 说明 |
|------|------|
| `portable/build-release.ps1` | 打包脚本 |
| `portable/一键启动.bat` | Windows 启动脚本 |
| `portable/menu.ps1` | PowerShell 管理菜单 |
| `portable/.env.default` | 默认配置模板 |
| `docs/一键启动脚本测试报告.md` | 启动脚本测试报告 |
| `pyproject.toml` | Python 项目配置 |
| `frontend/package.json` | 前端项目配置 |

---

## 更新历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2026-01-11 | 初始版本,支持自动打包和 Python 3.12 |

---

## 许可证

遵循项目主许可证: CC BY-NC-SA 4.0
